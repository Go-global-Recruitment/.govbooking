<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
// --- Countries ---
const countries = ["South Africa","USA","Australia","Canada","UK","India","Kenya","Nigeria","Ghana","Eswatini"];
const countrySelect = document.getElementById('country');
countries.forEach(c => { 
  const opt=document.createElement('option'); 
  opt.value=c; 
  opt.textContent=c; 
  countrySelect.appendChild(opt); 
});

// --- Provinces/States ---
const countryLocations = {
  "South Africa":["Gauteng","Western Cape","KwaZulu-Natal","Eastern Cape","Limpopo","Mpumalanga","Northern Cape","North West","Free State"],
  "USA":["California","New York","Texas","Florida","Illinois","Pennsylvania","Ohio","Georgia"],
  "Australia":["New South Wales","Victoria","Queensland","South Australia","Western Australia","Tasmania","Northern Territory","ACT"],
  "Canada":["Ontario","Quebec","British Columbia","Alberta","Manitoba"],
  "UK":["England","Scotland","Wales","Northern Ireland"],
  "India":["Maharashtra","Delhi","Karnataka","Tamil Nadu","West Bengal","Gujarat","Rajasthan"],
  "Kenya":["Nairobi","Mombasa","Kisumu","Nakuru","Eldoret"],
  "Nigeria":["Lagos","Abuja","Port Harcourt","Kano","Ibadan"],
  "Ghana":["Accra","Kumasi","Tamale"],
  "Eswatini":["Mbabane","Manzini","Lobamba"]
};

// --- Offices per province/state including Home Affairs ---
const officeLocations = {
  "Mbabane":["Mbabane Home Affairs","Mbabane Regional Office 1","Mbabane Regional Office 2"],
  "Manzini":["Manzini Home Affairs","Manzini Branch 1","Manzini Branch 2"],
  "Lobamba":["Lobamba Home Affairs"],
  "Gauteng":["Pretoria Home Affairs","Johannesburg Home Affairs","Soweto Regional Office"],
  "Western Cape":["Cape Town Home Affairs","Stellenbosch Branch"],
  "KwaZulu-Natal":["Durban Home Affairs","Pietermaritzburg Branch"]
};

function updateLocations() {
  const country = countrySelect.value;
  const locSelect = document.getElementById('location');
  const officeSelect = document.getElementById('office');
  locSelect.innerHTML='<option value="">Select Location</option>';
  officeSelect.innerHTML='<option value="">Select Office</option>';
  if(countryLocations[country]){
    countryLocations[country].forEach(loc=>{
      const opt=document.createElement('option');
      opt.value=loc;
      opt.textContent=loc;
      locSelect.appendChild(opt);
    });
  }
}

function updateOffices(){
  const loc = document.getElementById('location').value;
  const officeSelect = document.getElementById('office');
  officeSelect.innerHTML='<option value="">Select Office</option>';
  if(officeLocations[loc] && officeLocations[loc].length>0){
    officeLocations[loc].forEach(off=>{
      const opt=document.createElement('option');
      opt.value=off;
      opt.textContent=off;
      officeSelect.appendChild(opt);
    });
  } else {
    const opt=document.createElement('option');
    opt.value=loc+" Home Affairs";
    opt.textContent=loc+" Home Affairs";
    officeSelect.appendChild(opt);
  }
}

// --- Datepicker ---
// Disable all dates up to 2025-12-31, allow 2026 and beyond
const disabledDateRanges = [{ from: "2025-01-01", to: "2025-12-31" }];

// South African public holidays for 2025 & 2026
const publicHolidays = [
  // 2025
  "2025-01-01","2025-03-21","2025-04-18","2025-04-21","2025-04-27","2025-05-01",
  "2025-06-16","2025-08-09","2025-09-24","2025-12-16","2025-12-25","2025-12-26",
  // 2026
  "2026-01-01","2026-03-21","2026-04-03","2026-04-06","2026-04-27","2026-05-01",
  "2026-06-16","2026-08-09","2026-09-24","2026-12-16","2026-12-25","2026-12-26"
];

function disableDates(date) {
  const d = date.toISOString().split('T')[0];
  for (const r of disabledDateRanges) if (d >= r.from && d <= r.to) return true;
  return publicHolidays.includes(d);
}

flatpickr("#appointment_date", {
  dateFormat: "Y-m-d",
  minDate: "today",
  disable: [disableDates]
});

// --- NEW: Booking Number Yes/No Logic ---
const hasBookingSelect = document.getElementById("hasBooking");
const bookingWrapper = document.getElementById("bookingNumberWrapper");
const bookingInput = document.getElementById("bookingNumberInput");
const checkBtn = document.getElementById("checkBooking");

hasBookingSelect.addEventListener("change", () => {
  bookingWrapper.style.display = hasBookingSelect.value === "yes" ? "block" : "none";
});

checkBtn.addEventListener("click", () => {
  const booking = bookingInput.value.trim();
  if (!booking) return alert("Please enter your booking number.");
  localStorage.setItem("bookingNumber", booking);
  window.location.href = "final_summary.html";
});

// --- Form submission ---
const bookingForm = document.getElementById("bookingForm");
bookingForm.addEventListener("submit", function(e){
  e.preventDefault();
  let valid = true;
  bookingForm.querySelectorAll("input,select").forEach(el => {
    if(!el.checkValidity()){ el.classList.add("invalid"); valid = false; } 
    else el.classList.remove("invalid");
  });
  if(!valid) return;

  // --- Generate unique booking number ---
  const bookingNumber = 'BK' + Date.now();

  const bookingData = {
    id_number: document.getElementById("id_number").value,
    forenames: document.getElementById("forenames").value,
    surname: document.getElementById("surname").value,
    email: document.getElementById("email").value,
    cellphone: document.getElementById("cellphone").value,
    country_code: document.getElementById("country_code").value,
    country: document.getElementById("country").value,
    location: document.getElementById("location").value,
    office: document.getElementById("office").value,
    appointment_date: document.getElementById("appointment_date").value,
    appointment_time: document.getElementById("appointment_time").value,
    booking_number: bookingNumber
  };

  localStorage.setItem("bookingData", JSON.stringify(bookingData));
  window.location.href = "summary.html";
});
</script>
